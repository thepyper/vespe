# Piano di Miglioramento del Parsing LLM - Statistiche di Utilizzo dei Parser - 2025-09-18c

L'obiettivo di questo piano è estendere la funzione `parse_response` per restituire, oltre al risultato del parsing, anche una statistica minimale sull'utilizzo degli `SnippetParser`. Questa statistica sarà rappresentata da un `HashSet` contenente i `ParserSource` che hanno effettivamente contribuito al parsing.

## Fase 1: Modifica della Funzione `parse_response`

1.  **Modifica della Firma:**
    *   Cambiare la firma della funzione `pub fn parse_response(...) -> Vec<AssistantContent>` in `pub fn parse_response(...) -> (Vec<AssistantContent>, HashSet<ParserSource>)`.
    *   Aggiungere `use std::collections::HashSet;` e `use crate::llm::parsing::match_source::ParserSource;` a `src/llm/parsing/mod.rs`.

2.  **Inizializzazione del `HashSet`:**
    *   All'inizio della funzione `parse_response`, inizializzare un `HashSet<ParserSource>` vuoto per tenere traccia dei parser utilizzati.
        ```rust
        let mut used_parsers = HashSet::new();
        ```

3.  **Popolamento del `HashSet`:**
    *   All'interno del loop di parsing, ogni volta che un `SnippetMatch` viene trovato e il blocco `Text` viene suddiviso (cioè, `split_occurred` è `true`), inserire il `source` del match nel `used_parsers` `HashSet`.
        ```rust
        // ... all'interno del blocco `if let Some(m) = find_first_match_in_text(&text, parsers)`
        if let Some(m) = find_first_match_in_text(&text, parsers) {
            used_parsers.insert(m.source.clone()); // Inserisci la sorgente del parser
            // ... resto della logica di suddivisione
        }
        ```

4.  **Valore di Ritorno:**
    *   Alla fine della funzione, restituire la tupla `(blocks, used_parsers)`.

## Fase 2: Aggiornamento dei Siti di Chiamata

1.  **Modifica di `src/llm/llm_client.rs`:**
    *   Aggiornare la chiamata a `parsing::parse_response` per ricevere la tupla di ritorno.
        ```rust
        let (parsed_response, used_parsers) = parsing::parse_response(&response_content, &self.parsers);
        ```
    *   Per ora, il `used_parsers` `HashSet` può essere semplicemente loggato o ignorato, in quanto l'obiettivo attuale è solo predisporlo.
        ```rust
        info!("Used Parsers: {:#?}", used_parsers);
        ```

## Fase 3: Verifica e Test

1.  **Compilazione:** Eseguire `cargo check` per assicurarsi che tutte le modifiche siano sintatticamente corrette e che il progetto compili senza errori.
2.  **Test (Manuale/Unitario):** Verificare che il `HashSet` restituito contenga effettivamente i `ParserSource` corretti in base all'output dell'LLM e ai parser che hanno trovato un match.
