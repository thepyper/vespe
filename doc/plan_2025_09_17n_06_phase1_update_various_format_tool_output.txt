#### 1.3. Modifica della Logica `format_tool_output` nelle Policy (temporaneamente in `various_markdown_policy.rs`)

*   **Azione**: Modificare il metodo `format_tool_output` in ciascuna delle tre policy all'interno di `various_markdown_policy.rs` (prima di separarli). Questo metodo diventerÃ  una funzione associata (`fn`) invece di un metodo (`&self`) per semplicitÃ , poichÃ© non ha bisogno di accedere allo stato della policy per la formattazione dell'output del tool.
*   **Contenuto**:
    *   **`use` statements aggiuntivi**:
        ```rust
        // src/llm/impls/various_markdown_policy.rs (modifiche temporanee)
        use crate::llm::tool_output_formatters;
        use crate::llm::policy_types::PolicyType;
        use crate::llm::tool_types::ToolType;
        // ... altri use esistenti
        ```
    *   **Implementazione `format_tool_output` per `JsonMarkdownPolicy`**:
        ```rust
        impl JsonMarkdownPolicy {
            pub fn new() -> Self {
                Self {}
            }

            // Questa funzione associata ora delega al modulo tool_output_formatters
            fn format_tool_output(tool_output: &crate::llm::messages::ToolOutput, policy_type: PolicyType) -> Result<String> {
                let tool_type = ToolType::from(tool_output.tool_name.as_str());
                let formatted_result = tool_output_formatters::format_tool_output(tool_type, &tool_output.output, policy_type)?;

                Ok(format!(
                    "```tool_result\n{{\n  \"tool\": \"{}\",\n  \"call_id\": \"{}\",\n  \"result\": {}\n}}\n```",
                    tool_output.tool_name,
                    tool_output.call_id.as_deref().unwrap_or("unknown"),
                    formatted_result
                ))
            }
            // Rimuovere completamente la funzione `format_result_by_tool_type` da qui
        }
        ```
    *   **Implementazione `format_tool_output` per `XmlMarkdownPolicy`**:
        ```rust
        impl XmlMarkdownPolicy {
            pub fn new() -> Self {
                Self {}
            }

            fn format_tool_output(tool_output: &crate::llm::messages::ToolOutput, policy_type: PolicyType) -> Result<String> {
                let tool_type = ToolType::from(tool_output.tool_name.as_str());
                let formatted_result = tool_output_formatters::format_tool_output(tool_type, &tool_output.output, policy_type)?;

                Ok(format!(
                    "<tool_result>\n<tool_name>{}</tool_name>\n<call_id>{}</call_id>\n<result>\n{}\n</result>\n</tool_result>",
                    tool_output.tool_name,
                    tool_output.call_id.as_deref().unwrap_or("unknown"),
                    formatted_result
                ))
            }
            // Rimuovere completamente la funzione `format_result_by_tool_type` da qui
        }
        ```
    *   **Implementazione `format_tool_output` per `SectionsMarkdownPolicy`**:
        ```rust
        impl SectionsMarkdownPolicy {
            pub fn new() -> Self {
                Self {}
            }

            fn format_tool_output(tool_output: &crate::llm::messages::ToolOutput, policy_type: PolicyType) -> Result<String> {
                let tool_type = ToolType::from(tool_output.tool_name.as_str());
                let formatted_result = tool_output_formatters::format_tool_output(tool_type, &tool_output.output, policy_type)?;

                Ok(format!(
                    "## ðŸ”§ Tool Result: {}\n**Call ID:** {}\n**Output:**\n```json\n{}\n```",
                    tool_output.tool_name,
                    tool_output.call_id.as_deref().unwrap_or("unknown"),
                    formatted_result
                ))
            }
            // Rimuovere completamente la funzione `format_result_by_tool_type` da qui
        }
        ```
*   **Motivazione**: Delega la responsabilitÃ  della formattazione specifica del tool, riducendo la complessitÃ  e la duplicazione all'interno delle policy. Utilizza `ToolType` per una maggiore sicurezza.

**CONTINUA NEL FILE: `doc/plan_2025_09_17n_07_phase1_update_various_format_query.txt`**
