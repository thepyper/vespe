# Design - Gestione dei Task

## Obiettivo
Definire la struttura, il ciclo di vita e le interazioni per la gestione dei task all'interno del progetto Vespe, utilizzando il filesystem come base per la persistenza dello stato.

## Concetti Fondamentali

### Task
Un task rappresenta un'unità di lavoro discreta con un obiettivo specifico.

### Subtask
Un task può essere scomposto in uno o più subtask. La relazione tra task e subtask è gerarchica e si riflette nella struttura del filesystem.

## Struttura del Task (Filesystem-based)

Ogni task (e subtask) sarà rappresentato da una directory dedicata. All'interno di questa directory, i file conterranno i metadati e i contenuti relativi al task.

Esempio di struttura:

```
.vespe/tasks/
├── task_001_implement_feature_X/
│   ├── config.json             // Metadati immutabili
│   ├── objective.md            // Obiettivo (mutabile)
│   ├── plan.md                 // Piano di esecuzione
│   ├── status.json             // Stato corrente del task
│   ├── dependencies.json       // Dipendenze da altri task
│   └── subtasks/
│       ├── subtask_001_design_api/
│       │   ├── config.json
│       │   ├── objective.md
│       │   └── status.json
│       └── subtask_002_implement_frontend/
│           ├── config.json
│           ├── objective.md
│           └── status.json
└── task_002_fix_bug_Y/
    ├── config.json
    └── ...
```

### File di Configurazione del Task

1.  **`config.json` (Immutabile)**:
    *   `uid`: Stringa univoca per identificare il task (essenziale per referenziare dipendenze e per l'integrità del sistema).
    *   `name`: Nome leggibile del task.
    *   `created_by`: Utente o agente che ha creato il task.
    *   `created_at`: Timestamp di creazione.
    *   `parent_uid`: (Opzionale) UID del task genitore, se è un subtask.

    ```json
    {
      "uid": "tsk-abc123def456",
      "name": "Implementazione Autenticazione Utente",
      "created_by": "user_cli",
      "created_at": "2025-09-22T10:00:00Z",
      "parent_uid": null
    }
    ```

2.  **`objective.md` (Mutabile)**:
    *   Contiene la descrizione dettagliata dell'obiettivo del task. Può essere modificato nel tempo.

3.  **`plan.md` (Mutabile)**:
    *   Descrive i passi necessari per raggiungere l'obiettivo. Può essere generato dall'utente, da un LLM o da una combinazione.
    *   Potrebbe includere sezioni per domande all'utente o note.

4.  **`status.json` (Mutabile)**:
    *   `current_state`: Stato attuale del task (vedi "Ciclo di Vita del Task").
    *   `last_updated_at`: Timestamp dell'ultimo aggiornamento di stato.
    *   `progress`: (Opzionale) Percentuale di completamento o descrizione del progresso.

    ```json
    {
      "current_state": "created",
      "last_updated_at": "2025-09-22T10:00:00Z",
      "progress": "0%"
    }
    ```

5.  **`dependencies.json` (Opzionale, Mutabile)**:
    *   Un array di UID di task da cui questo task dipende.

    ```json
    {
      "depends_on": ["tsk-xyz789uvw012"]
    }
    ```

## Ciclo di Vita del Task (Stati)

I task possono transitare tra i seguenti stati:

*   **`created`**: Il task è stato definito, ma non è ancora iniziato.
*   **`planning`**: Il task è in fase di pianificazione (es. l'LLM sta elaborando un piano o chiedendo chiarimenti).
*   **`ready`**: Il task ha un piano e tutte le sue dipendenze sono soddisfatte, pronto per essere avviato.
*   **`started`**: L'esecuzione del task è iniziata.
*   **`paused`**: L'esecuzione del task è temporaneamente sospesa.
*   **`blocked`**: Il task è bloccato, in attesa di un'azione esterna o di una risoluzione di un problema.
*   **`changed`**: Il task è stato modificato (obiettivo, piano, ecc.) e potrebbe richiedere una ri-valutazione o ri-pianificazione.
*   **`done`**: Il task è stato completato con successo.
*   **`failed`**: Il task non è riuscito a completarsi a causa di un errore.
*   **`aborted`**: Il task è stato interrotto dall'utente o dal sistema prima del completamento.

## Relazioni e Dipendenze

*   **Gerarchia**: La struttura delle directory riflette la gerarchia task/subtask.
*   **Dipendenze**: Le dipendenze tra task sono esplicitate in `dependencies.json`. Queste sono l'unico criterio di ordinamento forzato. Un task non può passare allo stato `ready` o `started` se le sue dipendenze non sono `done` o `aborted` (a seconda della politica).
*   **Esecuzione**: I task senza dipendenze o con dipendenze soddisfatte possono essere eseguiti in parallelo o in qualsiasi ordine.

## Interazioni

*   **Creazione**: Un task può essere creato manualmente o tramite un comando CLI/API.
*   **Pianificazione**: La creazione del `plan.md` può essere assistita da un LLM, che può anche porre domande all'utente per affinare il piano.
*   **Progressione**: Gli stati del task vengono aggiornati in base all'avanzamento.
*   **Modifica**: L'obiettivo o il piano possono essere modificati, portando il task allo stato `changed`.
