
Look at the following excerpt from log, it will show you some formatting problems that lead the llm to reply with bad things.

2025-09-17T14:58:09.473116Z  INFO vespe::llm::llm_client: LLM Query (internal messages):
[
    System(
        "You are a helpful AI assistant. \r\n\r\nYOUR RESPONSE MUST BE FORMATTED USING MARKDOWN.\nYOU MUST ONLY USE THE FOLLOWING STRUCTURES:\n\n1.  TOOL CALLS: When you need to call a tool, you MUST use a JSON code block with the language identifier &#x60;tool_code&#x60;.\n    Example:\n    &#x60;&#x60;&#x60;tool_code\n    {\n      &quot;name&quot;: &quot;tool_name&quot;,\n      &quot;arguments&quot;: {\n        &quot;arg1&quot;: &quot;value1&quot;\n      }\n    }\n    &#x60;&#x60;&#x60;\n    YOU MUST ENSURE the JSON is valid and strictly adheres to the tool&#x27;s schema.\n\n2.  INTERNAL THOUGHTS: If you have an internal thought or reasoning, you MUST use a JSON code block with the language identifier &#x60;thought&#x60;.\n    Example:\n    &#x60;&#x60;&#x60;thought\n    {\n      &quot;reasoning&quot;: &quot;I need to do X because Y&quot;\n    }\n    &#x60;&#x60;&#x60;\n    YOU MUST ENSURE the JSON is valid and contains a &#x27;reasoning&#x27; field.\n\n3.  PLAIN TEXT: All other content MUST be plain text. DO NOT use any other markdown formatting (e.g., bold, italics, lists) for non-tool-call or non-thought content.\n\nYOU MUST NOT combine multiple tool calls or thoughts within a single markdown block. Each tool call or thought MUST be in its own distinct &#x60;tool_code&#x60; or &#x60;thought&#x60; block.\nYOU MUST NOT include any other markdown code blocks (e.g., &#x60;&#x60;&#x60;&#x60;json&#x60;, &#x60;&#x60;&#x60;&#x60;python&#x60;) unless explicitly instructed by a tool.\n\r\n\r\nYou can use the following tools:\r\n[\n  {\n    &quot;description&quot;: &quot;Echoes back the input string, transformed in three ways: lowercase, capitalized, and uppercase, separated by asterisks.&quot;,\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;The string to echo back.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;name&quot;: &quot;echo&quot;,\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The input string transformed into lowercase, capitalized, and uppercase, separated by asterisks.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  },\n  {\n    &quot;description&quot;: &quot;Reads the content of a specified file from the project sandbox. Input is a JSON object with a &#x27;path&#x27; string field.&quot;,\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;path&quot;: {\n          &quot;description&quot;: &quot;The path to the file to read, relative to the project sandbox.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;path&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;name&quot;: &quot;read_file&quot;,\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;content&quot;: {\n          &quot;description&quot;: &quot;The content of the file.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;content&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n]\n\n",
    ),
    User(
        "tell me a fortune, then send it through echo tool",
    ),
]
2025-09-17T14:58:09.474514Z  INFO vespe::llm::llm_client: LLM Query (formatted for LLM):
[
    ChatMessage {
        role: User,
        message_type: Text,
        content: "You are a helpful AI assistant. \r\n\r\nYOUR RESPONSE MUST BE FORMATTED USING MARKDOWN.\nYOU MUST ONLY USE THE FOLLOWING STRUCTURES:\n\n1.  TOOL CALLS: When you need to call a tool, you MUST use a JSON code block with the language identifier &#x60;tool_code&#x60;.\n    Example:\n    &#x60;&#x60;&#x60;tool_code\n    {\n      &quot;name&quot;: &quot;tool_name&quot;,\n      &quot;arguments&quot;: {\n        &quot;arg1&quot;: &quot;value1&quot;\n      }\n    }\n    &#x60;&#x60;&#x60;\n    YOU MUST ENSURE the JSON is valid and strictly adheres to the tool&#x27;s schema.\n\n2.  INTERNAL THOUGHTS: If you have an internal thought or reasoning, you MUST use a JSON code block with the language identifier &#x60;thought&#x60;.\n    Example:\n    &#x60;&#x60;&#x60;thought\n    {\n      &quot;reasoning&quot;: &quot;I need to do X because Y&quot;\n    }\n    &#x60;&#x60;&#x60;\n    YOU MUST ENSURE the JSON is valid and contains a &#x27;reasoning&#x27; field.\n\n3.  PLAIN TEXT: All other content MUST be plain text. DO NOT use any other markdown formatting (e.g., bold, italics, lists) for non-tool-call or non-thought content.\n\nYOU MUST NOT combine multiple tool calls or thoughts within a single markdown block. Each tool call or thought MUST be in its own distinct &#x60;tool_code&#x60; or &#x60;thought&#x60; block.\nYOU MUST NOT include any other markdown code blocks (e.g., &#x60;&#x60;&#x60;&#x60;json&#x60;, &#x60;&#x60;&#x60;&#x60;python&#x60;) unless explicitly instructed by a tool.\n\r\n\r\nYou can use the following tools:\r\n[\n  {\n    &quot;description&quot;: &quot;Echoes back the input string, transformed in three ways: lowercase, capitalized, and uppercase, separated by asterisks.&quot;,\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;The string to echo back.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;name&quot;: &quot;echo&quot;,\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The input string transformed into lowercase, capitalized, and uppercase, separated by asterisks.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  },\n  {\n    &quot;description&quot;: &quot;Reads the content of a specified file from the project sandbox. Input is a JSON object with a &#x27;path&#x27; string field.&quot;,\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;path&quot;: {\n          &quot;description&quot;: &quot;The path to the file to read, relative to the project sandbox.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;path&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;name&quot;: &quot;read_file&quot;,\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;content&quot;: {\n          &quot;description&quot;: &quot;The content of the file.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;content&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n]\n\n",
    },
    ChatMessage {
        role: User,
        message_type: Text,
        content: "tell me a fortune, then send it through echo tool",
    },
]
2025-09-17T14:59:08.571709Z  INFO vespe::llm::llm_client: LLM Raw Response:
```json
&#x60;&#x60;&#x60;tool_code
{
  &quot;name&quot;: &quot;fortune&quot;,
  &quot;arguments&quot;: {
    &quot;input_schema&quot;: {
      &quot;properties&quot;: {
        &quot;text&quot;: {
          &quot;description&quot;: &quot;A string to be transformed into a fortune.&quot;,
          &quot;type&quot;: &quot;string&quot;
        }
      },
      &quot;required&quot;: [
        &quot;text&quot;
      ],
      &quot;type&quot;: &quot;object&quot;
    },
    &quot;output_schema&quot;: {
      &quot;properties&quot;: {
        &quot;transformed_text&quot;: {
          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,
          &quot;type&quot;: &quot;string&quot;
        }
      },
      &quot;required&quot;: [
        &quot;transformed_text&quot;
      ],
      &quot;type&quot;: &quot;object&quot;
    }
  }
}
```

&amp;

```json
&#x60;&#x60;&#x60;tool_code
{
  &quot;name&quot;: &quot;fortune&amp;amp;send&quot;,
  &quot;arguments&quot;: {
    &quot;input_schema&quot;: {
      &quot;properties&quot;: {
        &quot;text&quot;: {
          &quot;description&quot;: &quot;A fortune to be sent through echo tool.&quot;,
          &quot;type&quot;: &quot;string&quot;
        }
      },
      &quot;required&quot;: [
        &quot;text&quot;
      ],
      &quot;type&quot;: &quot;object&quot;
    },
    &quot;output_schema&quot;: {
      &quot;properties&quot;: {
        &quot;transformed_text&quot;: {
          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,
          &quot;type&quot;: &quot;string&quot;
        }
      },
      &quot;required&quot;: [
        &quot;transformed_text&quot;
      ],
      &quot;type&quot;: &quot;object&quot;
    }
  }
}
```
2025-09-17T14:59:08.585497Z  INFO vespe::llm::llm_client: LLM Parsed Response:
[
    Text(
        "```json\n&#x60;&#x60;&#x60;tool_code\n{\n  &quot;name&quot;: &quot;fortune&quot;,\n  &quot;arguments&quot;: {\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;A string to be transformed into a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n}\n```\n\n&amp;\n\n```json\n&#x60;&#x60;&#x60;tool_code\n{\n  &quot;name&quot;: &quot;fortune&amp;amp;send&quot;,\n  &quot;arguments&quot;: {\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;A fortune to be sent through echo tool.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n}\n```",
    ),
    Text(
        "```json\n&#x60;&#x60;&#x60;tool_code\n{\n  &quot;name&quot;: &quot;fortune&quot;,\n  &quot;arguments&quot;: {\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;A string to be transformed into a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n}\n```\n\n&amp;\n\n```json\n&#x60;&#x60;&#x60;tool_code\n{\n  &quot;name&quot;: &quot;fortune&amp;amp;send&quot;,\n  &quot;arguments&quot;: {\n    &quot;input_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;text&quot;: {\n          &quot;description&quot;: &quot;A fortune to be sent through echo tool.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    },\n    &quot;output_schema&quot;: {\n      &quot;properties&quot;: {\n        &quot;transformed_text&quot;: {\n          &quot;description&quot;: &quot;The transformed string, representing a fortune.&quot;,\n          &quot;type&quot;: &quot;string&quot;\n        }\n      },\n      &quot;required&quot;: [\n        &quot;transformed_text&quot;\n      ],\n      &quot;type&quot;: &quot;object&quot;\n    }\n  }\n}\n```",
    ),
]