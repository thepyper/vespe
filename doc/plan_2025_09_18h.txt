**Piano per il Miglioramento del Tool Prompt tramite MarkupPolicy**

**Obiettivo:** Migliorare la chiarezza e l'efficacia del tool prompt fornito all'LLM, introducendo un'introduzione dinamica che spieghi la struttura dei tool e il meccanismo di invocazione, basandosi sulla `MarkupPolicy` attiva.

**Contesto e Motivazione:**
L'attuale tool prompt elenca i tool in modo "brutale", portando a incomprensioni da parte dell'LLM. È fondamentale fornire un contesto chiaro su come i tool sono definiti e, soprattutto, come devono essere invocati. La `MarkupPolicy` è il luogo ideale per definire queste istruzioni dinamiche, garantendo coerenza con il parsing dell'output.

**Stato Attuale:**
*   `MarkupPolicy` è un tratto che definisce `get_markup_instructions()` e `name()`.
*   `JsonMarkupPolicy` e `XmlMarkupPolicy` sono implementate.
*   `PromptTemplater::render_system_prompt` accetta `agent_name`, `tool_prompt` (una stringa generata da `ToolRegistry::get_tool_prompt()`) e `markup_policy`.
*   `system_prompt.hbs` include `{{{markup_instructions}}}` e `{{{tool_prompt}}}`.
*   `ToolRegistry::get_tool_prompt()` genera una stringa che elenca i tool con i loro metadati.

**Stato Desiderato:**
*   Il tratto `MarkupPolicy` include un nuovo metodo per fornire un "preambolo" specifico per l'invocazione dei tool.
*   Le implementazioni concrete di `MarkupPolicy` (es. `JsonMarkupPolicy`, `XmlMarkupPolicy`) forniscono un preambolo dettagliato che include la sintassi di invocazione specifica per il loro formato.
*   `PromptTemplater::render_system_prompt` inietta questo preambolo nel system prompt.
*   `system_prompt.hbs` ha un placeholder per questo preambolo, posizionato prima dell'elenco dei tool.
*   `ToolRegistry::get_tool_prompt()` si concentra esclusivamente sulla descrizione dei tool, senza introduzioni.

**Vantaggi Attesi:**
*   Significativo miglioramento nella comprensione dell'LLM su come e quando invocare i tool.
*   Riduzione degli errori di invocazione dei tool da parte dell'LLM.
*   Maggiore robustezza e affidabilità del sistema.
*   Centralizzazione delle istruzioni di invocazione dei tool nella `MarkupPolicy`.

**Piano di Implementazione:**

1.  **Modifica del Tratto `MarkupPolicy`:**
    *   Aggiungere un nuovo metodo al tratto `MarkupPolicy` in `src/llm/markup_policy.rs`:
        ```rust
        fn get_tool_invocation_preamble(&self) -> String;
        ```
    *   Questo metodo restituirà una stringa che spiega all'LLM come invocare i tool, inclusa la sintassi specifica del formato (JSON o XML).

2.  **Aggiornamento delle Implementazioni Concrete di `MarkupPolicy`:**
    *   **`JsonMarkupPolicy` (in `src/llm/impls/markup_policies.rs`):**
        *   Implementare `get_tool_invocation_preamble()` per fornire istruzioni chiare sull'invocazione di tool tramite blocchi JSON (````json { "tool_code": { "name": "...", "arguments": { ... } } } ````).
    *   **`XmlMarkupPolicy` (in `src/llm/impls/markup_policies.rs`):**
        *   Implementare `get_tool_invocation_preamble()` per fornire istruzioni chiare sull'invocazione di tool tramite blocchi XML (````xml <tool_code><tool_call><name>...</name><arguments>...</arguments></tool_call></tool_code> ````).

3.  **Modifica di `PromptTemplater::render_system_prompt`:**
    *   In `src/prompt_templating.rs`, modificare la funzione `render_system_prompt` per chiamare `markup_policy.get_tool_invocation_preamble()`.
    *   Aggiungere il risultato di questa chiamata ai dati passati al template Handlebars (es. come `"tool_invocation_preamble"`).

4.  **Aggiornamento del Template `system_prompt.hbs`:**
    *   In `.vespe/prompts/system_prompt.hbs`, aggiungere un nuovo placeholder `{{{tool_invocation_preamble}}}`.
    *   Posizionare questo placeholder *prima* dell'attuale `{{{tool_prompt}}}` per garantire che l'introduzione preceda l'elenco dei tool.

5.  **Revisione di `ToolRegistry::get_tool_prompt()` (se necessario):**
    *   Assicurarsi che `ToolRegistry::get_tool_prompt()` restituisca solo l'elenco formattato dei tool, senza alcuna introduzione o istruzione di invocazione, poiché queste saranno gestite dalla `MarkupPolicy`. (Dall'analisi precedente, sembra già fare questo, ma una verifica è opportuna).

6.  **Verifica e Test:**
    *   Eseguire `cargo check` per assicurarsi che il progetto compili.
    *   Eseguire `cargo run` con un comando di chat per verificare che il system prompt generato includa correttamente il nuovo preambolo e che l'LLM risponda in modo più accurato.