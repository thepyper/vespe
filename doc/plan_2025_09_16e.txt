**Refactoring Plan: Vespe - BasicAgent Technical Debt Reduction**

**Goal:** Refactor the `BasicAgent` to improve separation of concerns, making it cleaner, more maintainable, and testable by extracting prompt building and response parsing logic into dedicated modules.

**Phase 4: BasicAgent Technical Debt Reduction**

**Step 1: Create `src/agent/core` Directory**

*   **Action:** Create the `src/agent/core` directory.
*   **Git Action:** Commit changes: "refactor: Create src/agent/core directory for core agent logic."

**Step 2: Extract Prompt Building Logic**

*   **Action:** Create `src/agent/core/prompt_builder.rs`.
    *   Define a `PromptBuilder` struct.
    *   Move the logic for constructing the system prompt (including tool metadata formatting) from `BasicAgent::get_tool_prompt` into a method of `PromptBuilder` (e.g., `build_system_prompt`).
    *   The `PromptBuilder` will need access to `ToolRegistry` and `AgentDefinition`.
*   **Action:** Update `src/agent/impls/basic_agent.rs`.
    *   Remove `get_tool_prompt` method.
    *   Modify `BasicAgent::new` to accept a `PromptBuilder` instance.
    *   Modify `BasicAgent::execute` to use the `PromptBuilder` to get the system prompt.
*   **Action:** Update `src/agent/mod.rs` to export `core`.
*   **Action:** Create `src/agent/core/mod.rs` to export `prompt_builder`.
*   **Git Action:** Commit changes: "refactor: Extract prompt building logic into PromptBuilder."

**Step 3: Extract Response Parsing Logic**

*   **Action:** Create `src/agent/core/response_parser.rs`.
    *   Define a `ResponseParser` struct.
    *   Move the `parse_llm_response` function into a method of `ResponseParser` (e.g., `parse_response`).
    *   The `ResponseParser` will need access to `MalformedJsonHandling`.
*   **Action:** Update `src/agent/impls/basic_agent.rs`.
    *   Remove the standalone `parse_llm_response` function.
    *   Modify `BasicAgent::new` to accept a `ResponseParser` instance.
    *   Modify `BasicAgent::execute` to use the `ResponseParser` to parse LLM responses.
*   **Action:** Update `src/agent/core/mod.rs` to export `response_parser`.
*   **Git Action:** Commit changes: "refactor: Extract response parsing logic into ResponseParser."

**Step 4: Streamline `BasicAgent::execute`**

*   **Action:** Modify `src/agent/impls/basic_agent.rs`.
    *   Simplify the `execute` method. It should now primarily orchestrate calls to `PromptBuilder` and `ResponseParser`.
    *   The loop for tool calls will remain, but the parsing and action processing will be cleaner, relying on the new extracted components.
    *   Ensure the `final_response_parts` aggregation logic remains correct.
*   **Action:** Update `src/agent/agent_manager.rs` to instantiate and pass `PromptBuilder` and `ResponseParser` to `BasicAgent::new`.
*   **Git Action:** Commit changes: "refactor: Streamline BasicAgent::execute method for clearer orchestration."

**Step 5: Initial Prompt File Setup (Externalization)**

*   **Action:** Create a `.vespe/prompts` directory.
*   **Action:** Create a `system_prompt_template.txt` file inside `.vespe/prompts` with the current system prompt content from `BasicAgent::get_tool_prompt`.
*   **Action:** Modify `PromptBuilder` (in `src/agent/core/prompt_builder.rs`) to read this file content dynamically.
*   **Git Action:** Commit changes: "refactor: Externalize system prompt to file."

**Step 6: Test Refactored Agent**

*   **Action:** Run `cargo run -- chat my_agent "please think a bit, then reply with tool echo with a fortune; remember you can only reply with a pure json object, or list"`.
*   **Expected Outcome:** The agent should behave identically to its previous working state, but with a cleaner internal structure.
*   **Git Action:** (No direct Git action for test execution, but ensure previous steps are committed).
