@include rules
@include project
@include agent/linter

Ora voglio separare src/ast2/mod.rs in piu' files diversi.

Intanto fammi un piano ben fatto, considera di fare zero danni. Non partire con il piano subito, e dividilo in punti numerati.
Fai un piano gia' reale, leggendo i files che devi leggere.

<!-- answer-0b401bdb-85bd-427e-b348-98eb96601e11:begin -->
Okay, I understand. I will create a detailed, numbered plan to refactor `src/ast2/mod.rs` into multiple files, ensuring no functional changes are introduced. I will read the file first to understand its current structure.

Okay, I have analyzed the content of `src/ast2/mod.rs`. It contains definitions for AST nodes, error types, a parser implementation, and various parsing functions.

Here is the detailed plan to refactor `src/ast2/mod.rs` into multiple files, ensuring no functional changes are introduced:

### Refactoring Plan for `src/ast2/mod.rs`

The goal is to separate the large `mod.rs` file into smaller, more manageable modules, improving readability and maintainability without altering functionality.

1.  **Create `src/ast2/model.rs`:**
    *   **Action:** Create a new file `H:/my/github/vespe/src/ast2/model.rs`.
    *   **Content:** Move the following structs and their `impl` blocks into this new file:
        *   `Position`
        *   `Range`
        *   `Text`
        *   `CommandKind`
        *   `Parameters`
        *   `Argument`
        *   `Arguments`
        *   `Tag`
        *   `AnchorKind`
        *   `Anchor`
        *   `Content`
        *   `Document`
    *   **Dependencies:** Add `use serde_json;` and `use uuid::Uuid;` at the top of `model.rs` as `Parameters` and `Anchor` depend on them.

Esegui questo punto del piano, compila con "cargo test" alla fine per verificare che sia ancora tutto funzionante.

<!-- answer-aa9beee5-8f8d-4710-bf30-8a3fcd86d14b:begin -->
Okay, I will proceed with the next step of the refactoring plan.

First, I will extract the `Ast2Error` enum and `Result` type alias from `src/ast2/mod.rs`. Then, I will create `src/ast2/error.rs` with this content, including the necessary `use` statements. Finally, I will update `src/ast2/mod.rs` to remove the moved code and add the new module declaration and `use` statement.

Let's start by reading `src/ast2/mod.rs` again to get the exact content of the `Ast2Error` enum and `Result` type alias.Okay, I will proceed with the next step of the refactoring plan.

First, I will extract the `Parser` struct and its `impl` block from `src/ast2/mod.rs`. Then, I will create `src/ast2/parser.rs` with this content, including the necessary `use` statements. Finally, I will update `src/ast2/mod.rs` to remove the moved code and add the new module declaration and `use` statement.

Let's start by reading `src/ast2/mod.rs` again to get the exact content of the `Parser` struct and its `impl` block.
<!-- answer-aa9beee5-8f8d-4710-bf30-8a3fcd86d14b:end -->

2.  **Create `src/ast2/error.rs`:**
    *   **Action:** Create a new file `H:/my/github/vespe/src/ast2/error.rs`.
    *   **Content:** Move the `Ast2Error` enum and the `Result<T>` type alias into this new file.
    *   **Dependencies:** Add `use thiserror::Error;` and `use crate::ast2::model::Position;` at the top of `error.rs`.

3.  **Create `src/ast2/parser.rs`:**
    *   **Action:** Create a new file `H:/my/github/vespe/src/ast2/parser.rs`.
    *   **Content:** Move the `Parser` struct and all its associated `impl` methods (both immutable and mutable) into this new file.
    *   **Dependencies:** Add `use std::str::Chars;` and `use crate::ast2::model::Position;` at the top of `parser.rs`.

4.  **Create `src/ast2/parse_functions.rs`:**
    *   **Action:** Create a new file `H:/my/github/vespe/src/ast2/parse_functions.rs`.
    *   **Content:** Move all the `parse_document`, `parse_content`, `_try_parse_tag`, `_try_parse_anchor`, `_try_parse_command_kind`, `_try_parse_anchor_kind`, `_try_parse_parameters`, `_try_parse_parameter`, `_try_parse_arguments`, `_try_parse_argument`, `_try_parse_identifier`, `_try_parse_value`, `_try_parse_enclosed_value`, `_try_parse_enclosed_string`, `_try_parse_nude_value`, `_try_parse_nude_integer`, `_try_parse_nude_float`, `_try_parse_nude_bool`, `_try_parse_nude_string`, `_try_parse_uuid`, `_try_parse_text` functions into this file.
    *   **Dependencies:** Add the following `use` statements at the top of `parse_functions.rs`:
        ```rust
        use serde_json::json;
        use std::str::FromStr;
        use uuid::Uuid;
        use crate::ast2::model::{
            Anchor, AnchorKind, Argument, Arguments, CommandKind, Content, Document, Parameters, Tag, Text,
        };
        use crate::ast2::parser::Parser;
        use crate::ast2::error::{Ast2Error, Result};
        use crate::ast2::model::Range;
        ```

5.  **Update `src/ast2/mod.rs`:**
    *   **Action:** Modify the existing `H:/my/github/vespe/src/ast2/mod.rs` file.
    *   **Content:**
        *   Remove all the code that has been moved to the new files.
        *   Add `mod` declarations for the new files:
            ```rust
            pub mod model;
            pub mod error;
            pub mod parser;
            mod parse_functions;
            ```
        *   Add `use` statements to bring the necessary items into scope for `mod.rs` and for external modules that use `ast2`:
            ```rust
            pub use model::*;
            pub use error::{Ast2Error, Result};
            pub use parser::Parser;
            pub use parse_functions::*;
            ```
        *   Remove unused `use clap::builder::Str;` and `use std::str::Chars;` from `mod.rs`.

6.  **Verification:**
    *   After each step (or after all changes are applied), run `cargo check` to ensure there are no compilation errors.
    *   Run `cargo test` to ensure all existing tests still pass, confirming that no functional changes were introduced.

This plan ensures a gradual refactoring, allowing for verification at each step and minimizing the risk of introducing regressions. I will proceed with step 1.
<!-- answer-0b401bdb-85bd-427e-b348-98eb96601e11:end -->