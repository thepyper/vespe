# Plan for Integrating Handlebars for Prompt Generation

This plan outlines the steps to replace the current prompt generation logic with the Handlebars templating engine.

## 1. Add Handlebars Dependency

- **Action:** Add the `handlebars` crate to `Cargo.toml`.
- **Details:**
  ```toml
  [dependencies]
  handlebars = "5.1.0"
  ```

## 2. Create a Prompt Templating Service

- **Action:** Create a new file `src/prompt_templating.rs`.
- **Content:** This module will contain a `PromptTemplater` struct.
- **Details:**
    - The `PromptTemplater` will hold an instance of `handlebars::Handlebars`.
    - It will have a method `render_prompt(template_name: &str, data: &serde_json::Value) -> Result<String>` to render a specific template with provided data.
    - It will load prompt templates from a designated directory (e.g., `prompts/`).

## 3. Refactor Prompt Generation in `PromptBuilder`

- **File to modify:** `src/agent/core/prompt_builder.rs`
- **Actions:**
    1. Remove the existing string formatting logic for system prompts.
    2. Import and use the `PromptTemplater` to render the system prompt.
    3. The `PromptBuilder` will need to be initialized with a `PromptTemplater` instance.

## 4. Update Agent Initialization

- **Files to modify:** `src/agent/agent_manager.rs` and `src/agent/impls/basic_agent.rs`
- **Actions:**
    1. In `AgentManager::new`, initialize the `PromptTemplater`.
    2. Pass the `PromptTemplater` instance to `BasicAgent::new`.

## 5. Migrate Existing Prompts to Handlebars Templates

- **Action:** Create a `prompts/` directory (e.g., `sandbox/prompts/`).
- **Details:**
    - Move the system prompt logic from `PromptBuilder` into a new Handlebars template file (e.g., `sandbox/prompts/system_prompt.hbs`).
    - Ensure all dynamic parts of the prompt are replaced with Handlebars expressions (e.g., `{{tool_prompt}}`).

## 6. Verification

- **Action:** Build the project using `cargo build`.
- **Action:** Run the application using the `chat` command and verify that the agent still responds correctly, indicating successful prompt rendering.
- **Action:** Check for any new log messages or errors related to templating.
