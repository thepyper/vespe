# Piano di Refactoring: Centralizzazione della Formattazione del Prompt in AgentProtocol

## Obiettivo
Centralizzare la logica di formattazione del prompt all'interno del trait `AgentProtocol`, rimuovendo la responsabilità da `Project::call_llm` e migliorando la modularità e la flessibilità del sistema.

## Fasi del Piano

### Fase 0: Setup Iniziale e Commit
1.  **Creazione File di Piano:** Creare questo file (`doc/plan_2025_09_30c.txt`).
2.  **Commit Iniziale:** Effettuare un commit del solo file di piano.

### Fase 1: Definizione di `QueryContext` e Aggiornamento del Trait `AgentProtocol`
1.  **Localizzazione `AgentProtocol`:** Identificare il file contenente la definizione del trait `AgentProtocol` (probabilmente in `src/agent_protocol/mod.rs` o `src/agent_protocol.rs`).
2.  **Localizzazione Tipi:** Verificare le definizioni dei tipi `Message` e `ToolConfig` per assicurarsi degli import e dell'uso corretto.
3.  **Definizione `QueryContext`:** Creare una nuova struct `QueryContext` nel file appropriato (vicino ad `AgentProtocol` o in un nuovo modulo `query_context.rs`) utilizzando i tipi specificati:
    ```rust
    // Esempio di definizione (il percorso esatto potrebbe variare)
    // src/agent_protocol/query_context.rs
    use crate::llm_client::Message; // Assumendo il percorso corretto
    use crate::tool::ToolConfig; // Assumendo il percorso corretto

    pub struct QueryContext<'a> {
        pub task_context: &'a [Message],
        pub agent_context: &'a [Message],
        pub available_tools: &'a [ToolConfig],
        pub system_instructions: Option<&'a str>,
    }
    ```
4.  **Aggiornamento Trait `AgentProtocol`:** Modificare il trait `AgentProtocol` per includere la funzione `format_query` con il parametro `QueryContext`:
    ```rust
    // Esempio di modifica del trait
    trait AgentProtocol {
        // ... metodi esistenti ...
        fn format_query(&self, context: QueryContext) -> Result<String, AgentProtocolError>;
    }
    ```
5.  **Definizione `AgentProtocolError`:** Se non esiste, definire un enum `AgentProtocolError` di base per la gestione degli errori di `format_query`.
6.  **Commit:** Commit delle modifiche relative a `QueryContext` e al trait `AgentProtocol`.

### Fase 2: Refactoring della Struct `Agent`
1.  **Localizzazione `Agent`:** Identificare il file contenente la definizione della struct `Agent` (probabilmente `src/agent.rs`).
2.  **Rimozione `system_prompt`:** Rimuovere il campo `system_prompt` dalla struct `Agent`.
3.  **Considerazione `system_instructions`:** Se `system_instructions` deve essere un campo della struct `Agent`, aggiungerlo come `Option<String>`. Altrimenti, si assumerà che venga passato direttamente a `call_llm` da un altro punto. Per ora, si procederà con la rimozione di `system_prompt` e si valuterà l'aggiunta di `system_instructions` in `Agent` solo se necessario in base al contesto d'uso.
4.  **Commit:** Commit delle modifiche alla struct `Agent`.

### Fase 3: Aggiornamento di `Project::call_llm`
1.  **Localizzazione `Project::call_llm`:** Identificare la funzione `call_llm` in `src/project.rs`.
2.  **Modifica Firma `call_llm`:** Adattare i parametri di `call_llm` per accettare `task_context: &[Message]`, `agent_context: &[Message]`, `available_tools: &[ToolConfig]`, e `system_instructions: Option<&str>`.
3.  **Costruzione `QueryContext`:** All'interno di `call_llm`, creare un'istanza di `QueryContext` utilizzando i parametri ricevuti.
4.  **Chiamata a `agent_protocol.format_query()`:** Sostituire la logica esistente di formattazione del prompt con una chiamata a `self.agent_protocol.format_query(query_context)`.
5.  **Gestione `Result`:** Implementare la gestione degli errori per il `Result` restituito da `format_query`.
6.  **Commit:** Commit delle modifiche a `Project::call_llm`.

### Fase 4: Aggiornamento delle Implementazioni di `AgentProtocol`
1.  **Localizzazione Implementazioni:** Identificare tutti i blocchi `impl AgentProtocol for ...`.
2.  **Implementazione `format_query`:** Per ogni implementazione, fornire un'implementazione concreta per la funzione `format_query`. Questa funzione dovrà prendere il `QueryContext` e costruire la stringa finale del prompt basandosi sui requisiti specifici del protocollo. Qui risiederà la logica effettiva di prompt engineering.
3.  **Commit:** Commit delle implementazioni di `format_query`.

### Fase 5: Aggiornamento dei Punti di Chiamata
1.  **Ricerca Chiamate a `Project::call_llm`:** Trovare tutti i punti in cui `Project::call_llm` viene chiamato.
2.  **Adeguamento Argomenti:** Aggiornare questi punti di chiamata per passare i nuovi argomenti `task_context`, `agent_context`, `available_tools`, e `system_instructions`.
3.  **Commit:** Commit delle modifiche ai punti di chiamata.

### Fase 6: Test e Verifica
1.  **Compilazione:** Assicurarsi che l'intero progetto compili senza errori (`cargo check`).
2.  **Esecuzione Test Esistenti:** Se esistono test relativi a `Project` o `AgentProtocol`, eseguirli per assicurarsi che non ci siano regressioni (`cargo test`).
3.  **Verifica Manuale:** Se possibile, eseguire l'applicazione e verificare che l'interazione con l'LLM funzioni come previsto con la nuova formattazione del prompt.

---
