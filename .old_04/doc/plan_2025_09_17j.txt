## Plan to Address Markdown Policy and System Prompt Issues

### Problem 1: Mixed Policy in `DefaultMarkdownPolicy`

**Diagnosis:**
The `DefaultMarkdownPolicy` currently instructs the LLM to format tool calls and thoughts as JSON within markdown code blocks (e.g., ````tool_code\n{...}\n````). However, its `parse_response` method attempts to parse the *entire* LLM response as a single JSON object or an array of JSON objects, after stripping only generic markdown code blocks. This creates a mismatch where the parser is not correctly extracting the JSON from the specific `tool_code` or `thought` markdown blocks as instructed.

**Proposed Solution:**
To resolve this, we will introduce two distinct `MarkdownPolicy` implementations:

1.  **`JsonMarkdownPolicy` (New):** This policy will strictly adhere to the current instruction format where tool calls and thoughts are represented as JSON objects *within* markdown code blocks with specific language identifiers (`tool_code`, `thought`).
    *   `markdown_format_instructions`: Will remain similar to the current `DefaultMarkdownPolicy`'s instructions.
    *   `parse_response`: Will be refactored to actively *extract* JSON content from `tool_code` and `thought` markdown blocks, and handle plain text content separately. This will involve parsing the response string to identify these blocks and then deserializing their inner JSON.
    *   `format_query`: Will remain similar, ensuring that `AssistantContent::ToolCall` and `AssistantContent::Thought` are formatted as JSON within markdown code blocks.

2.  **`PlainTextPolicy` (New, or a better name if a different markdown format is intended):** This policy will be for simpler scenarios where the LLM is expected to return primarily plain text, or a different, simpler markdown structure. For now, we can make it a basic plain text policy.
    *   `markdown_format_instructions`: Will instruct the LLM to return plain text.
    *   `parse_response`: Will treat the entire response as plain text.
    *   `format_query`: Will format messages as plain text.

**Refactoring Steps for Problem 1:**

*   **Rename `DefaultMarkdownPolicy` to `JsonMarkdownPolicy`:** This better reflects its intended behavior.
*   **Modify `JsonMarkdownPolicy::parse_response`:** Implement logic to correctly parse markdown code blocks with `tool_code` and `thought` identifiers, extracting the inner JSON. Also, handle any surrounding plain text.
*   **Create `PlainTextPolicy`:** Implement a new struct and its `MarkdownPolicy` trait methods for plain text handling.
*   **Update `src/llm/impls/mod.rs`:** Reflect the new policy files.
*   **Update `LlmClient` and `AgentManager`:** Allow for selection of the appropriate `MarkdownPolicy` based on configuration or agent definition. For now, we can default to `JsonMarkdownPolicy`.

### Problem 2: Missing Markdown Policy in System Prompt

**Diagnosis:**
The `BasicAgent` correctly retrieves `markdown_instructions` from the `MarkdownPolicy` and passes them to the `PromptTemplater` under the key `markdown_instructions`. However, the `system_prompt.hbs` template (which is not directly visible but inferred to be the issue) is likely not using this variable, resulting in the LLM not receiving the necessary formatting instructions.

**Proposed Solution:**
Ensure the `system_prompt.hbs` template explicitly includes the `markdown_instructions` variable.

**Refactoring Steps for Problem 2:**

*   **Read `system_prompt.hbs`:** Get the current content of the system prompt template.
*   **Modify `system_prompt.hbs`:** Add `{{markdown_instructions}}` to the template to ensure the LLM receives the formatting guidelines.

### Overall Plan:

1.  **Read `system_prompt.hbs`:** Get the current content of the system prompt template.
2.  **Update `system_prompt.hbs`:** Insert `{{markdown_instructions}}` into the template.
3.  **Rename `default_markdown_policy.rs` and `DefaultMarkdownPolicy`:** Change to `json_markdown_policy.rs` and `JsonMarkdownPolicy`.
4.  **Refactor `JsonMarkdownPolicy::parse_response`:** Implement robust parsing for markdown code blocks with `tool_code` and `thought` identifiers.
5.  **Create `plain_text_policy.rs` and `PlainTextPolicy`:** Implement the new policy.
6.  **Update `src/llm/impls/mod.rs`:** Reflect the new policy files.
7.  **Update `LlmClient` instantiation:** Ensure `JsonMarkdownPolicy` is used where `DefaultMarkdownPolicy` was previously.
8.  **Verify:** Run tests (if available) and manually test agent interactions to ensure correct LLM response parsing and prompt generation.
