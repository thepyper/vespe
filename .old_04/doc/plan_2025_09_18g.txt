**Piano per l'Introduzione delle MarkupPolicy nel System Prompt**

**Obiettivo:** Implementare un sistema che permetta di iniettare istruzioni di markup specifiche nel system prompt dell'LLM. Questo sistema dovrà supportare diverse `MarkupPolicy`, ognuna delle quali definirà un set distinto di istruzioni di markup e il prompt associato. La selezione della policy sarà configurabile, con un default iniziale.

**Contesto e Motivazione:**
Attualmente, il parsing dell'output dell'LLM è stato reso più flessibile. Per guidare l'LLM a produrre output che siano più facilmente parsabili e conformi a formati desiderati (es. JSON, XML, sezioni specifiche), è necessario fornire istruzioni chiare nel system prompt. Tuttavia, diverse situazioni o agenti potrebbero richiedere diversi stili o formati di markup. L'introduzione delle `MarkupPolicy` permetterà di gestire questa variabilità in modo strutturato.

**Stato Attuale:**
*   Il sistema genera system prompt, ma senza un meccanismo strutturato per l'iniezione di istruzioni di markup variabili.
*   I parser sono stati refactorizzati per essere più modulari e flessibili.

**Stato Desiderato:**
*   Definizione di un tratto `MarkupPolicy` che specifichi il comportamento di una policy di markup.
*   Implementazione di diverse `MarkupPolicy` concrete (es. `JsonMarkupPolicy`, `XmlMarkupPolicy`, `SectionsMarkupPolicy`).
*   Un meccanismo per selezionare la `MarkupPolicy` desiderata (inizialmente un default, poi configurabile).
*   Iniezione delle istruzioni di markup generate dalla policy selezionata nel system prompt.

**Vantaggi Attesi:**
*   Migliore controllo sulla formattazione dell'output dell'LLM.
*   Maggiore flessibilità per adattare l'LLM a diversi requisiti di parsing.
*   Miglioramento della robustezza del sistema grazie a output più prevedibili.
*   Facilità di estensione per nuove policy di markup in futuro.

**Piano di Implementazione:**

1.  **Definizione del Tratto `MarkupPolicy`:**
    *   Creare un nuovo tratto `MarkupPolicy` (es. in `src/llm/markup_policy.rs` o `src/llm/mod.rs`) che definisca un metodo per ottenere le istruzioni di markup da iniettare nel system prompt (es. `fn get_markup_instructions(&self) -> String`).
    *   Questo tratto potrebbe anche definire metodi per ottenere un "nome" o un "identificatore" della policy.

2.  **Implementazione delle `MarkupPolicy` Concrete:**
    *   **`JsonMarkupPolicy`:** Implementare una policy che generi istruzioni per l'LLM per produrre output in formato JSON (es. "Always respond with JSON, enclosed in ```json ... ``` blocks.").
    *   **`XmlMarkupPolicy`:** Implementare una policy che generi istruzioni per l'LLM per produrre output in formato XML (es. "Always respond with XML, enclosed in ```xml ... ``` blocks, using `<tool_code>` tags for tool calls.").
    *   **`SectionsMarkupPolicy` (Esempio Futuro):** Potrebbe essere una policy che guida l'LLM a strutturare l'output in sezioni con titoli specifici.

3.  **Integrazione con il System Prompt:**
    *   Identificare il punto in cui il system prompt viene costruito (probabilmente in `src/prompt_templating.rs` o nel modulo `agent`).
    *   Modificare la logica di costruzione del system prompt per accettare un'istanza di `Box<dyn MarkupPolicy>`.
    *   Chiamare il metodo `get_markup_instructions()` della policy selezionata e iniettare il risultato nel system prompt.

4.  **Gestione della Selezione della Policy (Default Iniziale):**
    *   Per ora, definire una `MarkupPolicy` di default (es. `JsonMarkupPolicy`) che verrà utilizzata se non specificato diversamente.
    *   Questo default sarà gestito nel punto in cui l'istanza della `MarkupPolicy` viene creata e passata al costruttore del system prompt.
    *   In futuro, questa selezione potrà essere resa configurabile tramite `AgentConfig` o `LlmConfig`.

5.  **Aggiornamento dei Moduli Coinvolti:**
    *   `src/llm/mod.rs`: Potrebbe essere necessario esporre il tratto `MarkupPolicy` e le implementazioni concrete.
    *   `src/agent/agent_manager.rs`: Aggiornare la creazione dell'agente per passare la `MarkupPolicy` al costruttore del system prompt o all'LLM client.
    *   `src/prompt_templating.rs` (o dove il system prompt è costruito): Modificare la funzione/metodo che costruisce il system prompt per accettare e utilizzare la `MarkupPolicy`.

**Considerazioni:**
*   Inizialmente, le istruzioni di markup saranno semplici stringhe. In futuro, potrebbero diventare più complesse, magari utilizzando un template engine.
*   La relazione tra `MarkupPolicy` e i `SnippetParser` dovrebbe essere chiara: la policy guida l'LLM a produrre un certo formato, e i parser sono responsabili di estrarre quel formato.