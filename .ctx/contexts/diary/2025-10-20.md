@include rules
@include project
@include agent/linter

voglio dividere src/ast2/mod.rs in diversi files, per migliore organizzazione.
Un problema che incontrerai e' che i test sono stati messi in una sottocartella / sottomodulo.
So che c'e' un modo (#path? o qualcosa di simile) che permette di "includere" dei files,
in modo da mantenere la sottocartella separata, ma dal punto di vista di rust tenere i test 
nello stesso modulo (ast2). Vorrei usassi questo approccio.

Studia il codice e proponi un refactoring in files.
Non eseguirlo, chiedi prima la mia approvazione.

<!-- answer-6437d07d-21dd-4b2d-87f2-b6cf893144a2:begin -->
Okay, I understand. I will analyze `src/ast2/mod.rs` to propose a refactoring plan that splits the code into multiple files while keeping the tests within the `ast2` module using the `#path` attribute, as you requested. I will then present this plan for your approval before making any changes.

Okay, I've analyzed `src/ast2/mod.rs`. It contains core data structures, the `Parser` implementation, and various parsing functions for document elements like tags, anchors, parameters, arguments, and values.

I propose the following refactoring plan to improve organization:

**New File Structure:**

```
src/ast2/
├── mod.rs
├── ast_types.rs          // Position, Range, Ast2Error, Result, Text, CommandKind, Parameters, Argument, Arguments, Tag, AnchorKind, Anchor, Content, Document, and their impls.
├── parser.rs             // The Parser struct and all its methods.
├── parse_document.rs     // parse_document, parse_content.
├── parse_tag_anchor.rs   // _try_parse_tag, _try_parse_anchor, _try_parse_command_kind, _try_parse_anchor_kind.
├── parse_params_args.rs  // _try_parse_parameters, _try_parse_parameter, _try_parse_arguments, _try_parse_argument.
├── parse_values.rs       // _try_parse_identifier, _try_parse_value, _try_parse_enclosed_value, _try_parse_enclosed_string, _try_parse_nude_value, _try_parse_nude_integer, _try_parse_nude_float, _try_parse_nude_bool, _try_parse_nude_string, _try_parse_uuid.
├── parse_text.rs         // _try_parse_text.
└── tests/                // Existing test files will remain here.
    └── mod.rs            // Will contain `mod` declarations for individual test files and `use super::*;`.
```

**`src/ast2/mod.rs` will be updated to:**
*   Contain `pub use` statements to re-export items from the new modules.
*   Include the test module using `#[cfg(test)] #[path = "tests/mod.rs"] mod tests;`.

**Inside `src/ast2/tests/mod.rs`:**
*   It will declare its submodules (e.g., `mod utils;`, `mod test_position_range;`).
*   It will use `use super::*;` to bring items from the `ast2` module into scope for the tests.

**Inside individual test files (e.g., `src/ast2/tests/test_position_range.rs`):**
*   They will use `use super::super::*;` to access items from the `ast2` module.

This plan separates concerns into logical files, improving modularity and readability, while maintaining the test structure as requested.

Do you approve this refactoring plan?
<!-- answer-6437d07d-21dd-4b2d-87f2-b6cf893144a2:end -->

Integra nel piano il seguente requisito: rendere privata la API, all'esterno si devono vedere solamente: parse_document e i tipi della AST che ritorna. il resto e' privato. Puoi integrare il piano?

<!-- answer-17d0d8af-3481-4744-a83a-488c366c698e:begin -->
Okay, I understand. I will integrate the privacy requirement into the refactoring plan. The goal is to expose only `parse_document` and the AST types it returns, making all other parsing logic and internal structures private to the `ast2` module.

Here is the revised refactoring plan:

**New File Structure:**

```
src/ast2/
├── mod.rs                // Module declarations and public re-exports
├── ast_types.rs          // Public AST types (Position, Range, Document, Content, Tag, etc.)
├── parser.rs             // Internal Parser struct and its core methods
├── parse_document.rs     // Public `parse_document` function and its direct internal helpers
├── parse_tag_anchor.rs   // Internal parsing helpers for tags and anchors
├── parse_params_args.rs  // Internal parsing helpers for parameters and arguments
├── parse_values.rs       // Internal parsing helpers for various value types
├── parse_text.rs         // Internal parsing helpers for text content
└── tests/                // Existing test files will remain here.
    └── mod.rs            // Will contain `mod` declarations for individual test files and `use super::*;`.
```

**`src/ast2/mod.rs` will be updated to:**

1.  **Declare internal modules:**
    ```rust
    mod ast_types;
    mod parser;
    mod parse_document;
    mod parse_tag_anchor;
    mod parse_params_args;
    mod parse_values;
    mod parse_text;
    ```
2.  **Re-export only the public API:** This includes the `parse_document` function and all the AST types that are part of its return value or public interface.
    ```rust
    pub use ast_types::{Position, Range, Ast2Error, Result, Text, CommandKind, Parameters, Argument, Arguments, Tag, AnchorKind, Anchor, Content, Document};
    pub use parse_document::parse_document;
    ```
3.  **Include the test module:**
    ```rust
    #[cfg(test)]
    #[path = "tests/mod.rs"]
    mod tests;
    ```

**Visibility within new files:**

*   **`ast_types.rs`**: All structs, enums, and their `impl` blocks defined here will be `pub` to be accessible from outside the `ast2` module via `mod.rs` re-exports.
*   **`parser.rs`**: The `Parser` struct and all its methods will be `pub(crate)`. This makes them accessible within the `ast2` module (e.g., by `parse_document.rs`) but not from outside the `vespe` crate.
*   **`parse_document.rs`**: The `parse_document` function will be `pub fn parse_document(...)`. Any helper functions within this file (e.g., `parse_content`) will be `pub(crate)` or private (`fn parse_content(...)`) as they are internal to the parsing process.
*   **`parse_tag_anchor.rs`, `parse_params_args.rs`, `parse_values.rs`, `parse_text.rs`**: All functions within these files will be `pub(crate)`. They are internal parsing utilities used by the `Parser` or `parse_document` and should not be exposed outside the `ast2` module.

**Inside `src/ast2/tests/mod.rs`:**

*   It will declare its submodules (e.g., `mod utils;`, `mod test_position_range;`).
*   It will use `use super::*;` to bring all items (public and `pub(crate)`) from the `ast2` module into scope for the tests.

**Inside individual test files (e.g., `src/ast2/tests/test_position_range.rs`):**

*   They will use `use super::super::*;` to access items from the `ast2` module.

This revised plan ensures that the external API of the `ast2` module is clean and minimal, exposing only what's necessary for consumers, while maintaining internal modularity and testability.

Do you approve this refined refactoring plan?
<!-- answer-17d0d8af-3481-4744-a83a-488c366c698e:end -->
